@{
    ViewData["Title"] = "Generar y enviar PDF desde TinyMCE";
}

<h2>Generar y enviar PDF desde TinyMCE</h2>

<textarea id="myTextarea" name="myTextarea">Contenido del PDF</textarea>
<button onclick="sendContent()">Generar y Enviar PDF</button>
<button onclick="pdf()">Generar</button>
<button onclick="cargarContenido()">Cargar Documento word</button>

@section Scripts {
    <script src="https://cdn.tiny.cloud/1/g2ldbjzxmnlz2eni76krjw63uzjywfzj9fpj6hgiub1g7dyw/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script>
        function sendContent() {
            var content = tinymce.get('myTextarea').getContent();
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '@Url.Action("GenerarPDF", "/Home")');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({ content: content }));
        }

        function pdf() {
            var pdf = tinymce.activeEditor.plugins.export.convert('clientpdf', {});
            pdf.then(function (result) {
                // Enviar el resultado al servidor
                var formData = new FormData();
                formData.append('file', result, 'archivo.pdf'); // Ajusta el nombre del archivo según sea necesario

                fetch('/Home/RecibirPDF', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    // Manejar la respuesta del servidor si es necesario
                    console.log(data);
                    alert("Archivo Creado correctamente");
                })
                .catch(error => {
                    // Manejar cualquier error de la solicitud
                    console.error('Error al enviar los datos al servidor:', error);
                });
            }).catch(function (error) {
                // Manejar cualquier error que ocurra durante la conversión
                console.error('Error durante la conversión a PDF:', error);
            });

        }

        function cargarContenido() {
            fetch('/Home/CargarDocumento', {
                method: 'POST'
            })
                .then(response => response.text())
                .then(data => {
                    tinymce.activeEditor.setContent(data); // Carga el contenido en TinyMCE
                })
                .catch(error => {
                    console.error('Error al cargar el documento:', error);
                });
        }





        tinymce.init({
            selector: 'textarea',
            plugins: ' autolink charmap  lists  searchreplace table visualblocks wordcount checklist casechange preview export formatpainter pageembed permanentpen advtemplate advtable advcode editimage tableofcontents powerpaste tinymcespellchecker autocorrect a11ychecker typography inlinecss template',
            toolbar: 'undo redo | fontfamily fontsize | bold italic underline strikethrough |  table  | align lineheight | tinycomments | checklist numlist bullist indent outdent | preview | export | template | inserttemplate | addtemplate',
            tinycomments_mode: 'embedded',
            tinycomments_author: 'Author name',
            mergetags_list: [
                { value: 'First.Name', title: 'First Name' },
                { value: 'Email', title: 'Email' },
            ],
            ai_request: (request, respondWith) => respondWith.string(() => Promise.reject("See docs to implement AI Assistant")),
            setup: function (editor) {
                // Evento que se dispara al inicializarse el editor
                editor.on('init', function () {
                    // Contenido de la cabecera
                    var headerContent = '<p>Fecha : MARTES, 22 DE OCTUBRE DE 2023 RSV729551072<br>Paciente : reter Paterno 1428634 Materno 1428634<br>Edad : 70 A&Ntilde;OS Fecha de Nacimiento : 03/OCT/1953<br>Sexo : FEMENINO M&eacute;dico solicitante : AQC<br>Sucursal : CULIACAN<br>Nombre del estudio : ULTRASONIDO HIGADO Y VIAS BILIARES</p>';

                   

                    // Contenido del editor
                    var mainContent = editor.getContent();


                    // Contenido del pie de página
                    var footerContent = '<div style="position: absolute; bottom: 10px; width: 100%; text-align: center;">Este es mi pie de página</div>';

                    // Unir contenido: cabecera + contenido principal + pie de página
                    var fullContent = headerContent + mainContent + footerContent;

                    // Establecer el contenido completo en el editor
                    editor.setContent(fullContent);
                });
            }


        });
    </script>
}
